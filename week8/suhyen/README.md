# 3. 추적

### 오픈텔레메트리 추적 소개

- 오픈텔레메트리가 설명하는 스팬은 작업 단위를 나타낸다. 다수의 스팬은 추적을 구성하며, 다음과 같은 데이터를 포함한다: 부모 스팬 ID, 추적이 시작되고 끝난 시간, 스팬 콘텍스트, 스팬 속성, 스팬 이벤트, 스팬 링크, 스팬 상태 등
- 레거시 소스에 관측 가능성을 구현하는 경우라면 개발자가 메트릭과 로그를 변경하기 쉽지 않다. 많은 변경이 필요할 뿐 아니라 운영에서 실행되고 있는 소스를 변경하고 빌드, 배포하는 작업은 부담스러운 업무다. 이러한 경우에는 추적을 생성하고, 추적으로부터 메트릭과 로그를 자동 생성하는 방법을 권장한다.
- span attributes: key-value 형식, 스팬에 연관된 속성 설정
    - SetAttributes()
- span events: 스팬에 추가되는 순간과 관련된 정보
    - 이벤트 이름, 이벤트가 추가된 시간 또는 사용자가 제공한 타임스탬프, 이벤트를 추가로 설명하는 0개 이상의 속성
    - AddEvent()
- span links: 다른 스팬과의 관계 정의
    - 연결할 스팬의 스팬 콘텍스트
    - 링크를 추가로 설명하는 0개 이상의 속성
- span kind: 스팬의 역할
    - INTERNAL(기본), CLIENT(동기 요청 발신자), SERVER(동기 요청 응답자), PRODUCER(비동기 요청 발신자), CONSUMER(비동기 요청 응답자)
- context: 구현 전반에 걸친 콘텍스트 API를 가진 불변 데이터 저장소
    - 콘텍스트를 전송하는 데 사용되는 캐리어 매체는 HTTP 헤더

### 추적 파이프라인 구성

<img width="407" alt="스크린샷 2024-12-21 오후 3 22 59" src="https://github.com/user-attachments/assets/5f505da4-2e7e-41e6-bc00-a2356bc36b0e" />

1. 트레이서 획득: 추적 데이터에 대한 제너레이터인 트레이서(TraceProvider)를 획득한다.
2. 추적 데이터 생성: 이전에 얻은 트레이서 인스턴스에서 start_span을 호출한다.
3. 콘텍스트 API: 콘텍스트 API를 사용하여 새로운 콘텍스트에 현재 스팬을 연결하고, 해당 콘텍스트를 활성화한다.
4. 스팬 프로세서 & 익스포터: SimpleSpanProcessor/BatchSpanProcessor가 스팬 익스포트 작업을 처리한다.

# 4. 메트릭

### 오픈텔레메트리 메트릭 소개

- 메트릭 분석은 애플리케이션에서 일어나는 일에 대한 정보를 이해할 수 있는 한 가지 방법이다.
- 오픈텔레메트리 메트릭 API는 기존의 프로메테우스 메트릭 API와는 많은 차이점이 있다. 프로메테우스는 4개의 메트릭 유형을 제공하지만, 오픈텔레메트리는 6개 메트릭 Counter, Asynchronous Counter, UpDownCounter, Asynchronous UpDownCounter, (Asynchronous) Gauge, Histogram
- 트레이서와 대조적으로 미터는 메트릭을 생성하지 않는다. 미터의 역할은 카운터, 게이지, 히스토그램 등 계측기를 생산하는 것이다.
    - 동기 계측기의 경우 측정을 기록할 시간이 되면 계측기에서메서드를 호출하고, 비동기실 계측기의 경우 계측기 생성 시 콜백 메서드를 구성한다.
    - 히스토르램이 있는 메트릭을 생성하는 데 사용되는 방법을 레코드라고 한다.

### 메트릭 파이프라인 구성

<img width="337" alt="스크린샷 2024-12-21 오후 3 47 53" src="https://github.com/user-attachments/assets/c44403cf-a189-46b5-ae3f-9b7a36c4d41d" />

1. MeterProvider는 메트릭을 생성하고 Meter에 대한 액세스를 제공한다.
2. MetricReader는 기록되는 메트릭을 수집한다.
3. MetricExporter는 메트릭을 다양한 프로토콜에 대한 출력 형식으로 변환하는 메커니즘을 제공한다. 

### 이그젬플러

- 메트릭은 그 자체로 도움이 되는 경우가 많지만, 추적 정보와 상관관계가 있을 때 시스템에서 발생하는 이벤트에 대해 훨씬 더 많은 콘텍스트와 깊이를 제공한다. 이그젬플러는 활성 스팬에 대한 정보를 포함하는 메트릭을 활성화하여 오픈텔레메트리에서 이를 수행하는 도구를 제공한다.
- 프로메테우스 메트릭이 업계 표준으로 인식되는 현 상황에서, 앞으로 오픈텔레메트리 메트릭이 얼마나 널리 활용될지는 미지수다. 작가의 개인적인 생각으로는 오픈텔레메트리 메트릭의 메시지 형식이 복잡해서 이를 해석하고 활용하는 데 어려움이 많을 것으로 예측한다.
- **Span metrics**를 사용해서 처리 시간, 개수 등을 자동적으로 생성할 수 있다. 커스텀 메트릭의 개발에 부담이 있다면 추적을 개발하고, span metrics를 사용해서 메트릭을 생성하고, 오픈텔레메트리 컬렉터를 사용해서 로그를 생성하는 것도 대안이 될 수 있다.

# 5. 로그

### 오픈텔레메트리 로그 소개

- 로그는 구조화와 비구조화된 로그로 나뉘는데, 오픈텔레메트리는 구조화된 로깅을 개발할 수 있는 프레임워크를 제공한다. 이전에 설명한 두 신호와 달리 오픈텔레메트리 로깅 신호는 로깅 인터페이스 표준화와 관련이 없다. 오픈텔레메트리는 로깅을 생성할 수 있는 API를 제공하지만, 주된 목적은 기존 로깅 기능에 연결하는 것이다. 즉, 로그를 구조적으로 출력하고, 해당 로그를 다른 신호와 상관시키는 메커니즘을 제공하는 것이다.
    - 오픈텔레메트리 로깅의 OTLPHandler는 언어별 로깅 라이브러리와 연계한다. (OTLPHandler는 오픈텔레메트리 SDK 패키지 1.10.0 이후 릴리스에서 LoggingHandler로 이름이 변경되었다.)
    - 기존 로깅 라이브러리에 추가되는 플러그인 개념

### 로그 파이프라인 구성

<img width="360" alt="스크린샷 2024-12-21 오후 10 14 45" src="https://github.com/user-attachments/assets/3dda546c-82ba-494c-a0c8-86549ea0ff28" />

1. LogEmitterProvider: 하나 이상의 로그 이미터를 인스턴스화하는 메커니즘 제공
2. LogEmitter: 로그 레코드 데이터 생성
3. LogExporter: 로그 레코드를 사용하고 데이터를 백엔드로 보냄

<details>
<summary>텔레메트리 데이터별 샘플링 방법</summary>

텔레메트리는 기본적으로 대용량 트랜잭션이다. 과도한 트래픽을 처리해야 하는 경우가 빈번한데, 추적의 경우에는 샘플링을 사용해서 처리하는 비율을 정할 수 있다. 메트릭의 경우에는 수집 주기를 조절하는 것도 하나의 방법이나, 저장 시점에 해상도를 변경하는 것도 대안이다. 로그는 샘플링과 수집 주기를 설정하는 것이 불가능한 대신에 로그 레벨을 조절해서 수집되는 로그의 양을 조절하는 것이 일반적이다.

</details>

# 6. 컬렉터

### 오픈텔레메트리 컬렉터 소개

- 오픈텔레메트리 컬렉터는 여러 데이터 형식을 처리할 수 있는 유연성을 제공하고, 텔레메트리 데이터의 구현과 관리를 애플리케이션으로부터 분리한다.

<details>
<summary>OpenTelemetry Collector vs Fluent Bit vs Datadog</summary>

| **특징/항목** | **OpenTelemetry Collector** | **Fluent Bit** | **Datadog** |
| --- | --- | --- | --- |
| **주요 기능** | 텔레메트리 수집(트레이스, 메트릭, 로그) | 로그 수집 및 처리 (메트릭도 지원) | 풀스택 관측성(Apm, 로그, 메트릭) |
| **오픈소스 여부** | 예 | 예 | 아니오 (유료 서비스) |
| **백엔드와의 통합** | 다양한 백엔드(Jaeger, Prometheus, Datadog 등) | 여러 로그 및 메트릭 백엔드와 통합 가능 | 주로 Datadog와 통합, 외부 지원 제한적 |
| **사용자 정의 가능성** | 프로세서와 익스포터를 통한 높은 커스터마이징 가능 | 로그 기반 사용 사례에 대한 제한적 커스터마이징 | 커스터마이징은 제한적 |
| **자원 효율성** | 설정에 따라 자원 소모가 다름 | 경량화되어 성능 최적화가 잘 됨 | Datadog에서 관리되므로 자원 스케일링을 Datadog이 처리 |
| **주요 사용 사례** | 클라우드 네이티브 관측성과 다양한 백엔드 통합 | 경량의 로그 수집 및 처리, 특히 컨테이너 환경 | APM, 로그, 메트릭을 모두 포함한 풀스택 관측성 |

</details>

### 컬렉터 파이프라인 구성

<img width="434" alt="스크린샷 2024-12-21 오후 6 28 20" src="https://github.com/user-attachments/assets/e1998147-18f3-41a8-bc05-b1b9180c3116" />

리시버

- 데이터를 pull 혹은 push 방식으로 컬렉터에 가져오는 역할
- 데이터 수신 형식은 OTLP(기본)부터 예거, 프로메테우스 형식까지 다양

프로세서

- 배치 처리, 메타데이터 추가, 샘플링 등의 작업 수행
- 상관관계 구현을 위한 이그젬플러, 스팬 메트릭 등의 기능 제공

익스포터

- 데이터를 다양한 관측 가능성 백엔드로 보내는 역할

<details>
<summary>예시 코드</summary>

```yaml
receivers:
	jaeger:
		protocols:
			thrift_http:
exporters:
	otlp:
		endpoint: tempo:4317
		insecure: true
service:
	pipelines:
		traces:
			receivers: [jaeger]
			exporters: [otlp]
```

</details>

### 컬렉터의 장점

- 컬렉터는 간단한 구성만으로 데이터의 라우팅과 필터링이 가능하며, 개발자의 추가적인 코드 개발이 필요 없다. 또한, 필터링으로 데이터 누출을 방지하고 데이터를 안전하게 전달할 수 있다.
- 오픈텔레메트리 컬렉터는 그라파나에서 제공하는 고급 상관관계 기능과 오픈서치에서 필요로 하는 멀티 테넌트를 지원한다. 특정 설루션에 대한 종속성을 낮추고, 표준에 기반한 시스템 구축이 가능한다.

# 7. 오픈텔레메트리 데모

### o11y shop 데모 아키텍처

![스크린샷 2024-12-21 오후 3 13 01](https://github.com/user-attachments/assets/55b1e04d-1c03-4bb4-88c4-ff1439c17bd7)

### 전체 파이프라인 아키텍처

<img width="498" alt="스크린샷 2024-12-22 오전 1 08 42" src="https://github.com/user-attachments/assets/464ec80c-04ba-4ec4-ac46-8ab54cba73e2" />

- 오픈텔레메트리 컬렉터를 사용한 추적 파이프라인
- 오픈텔레메트리 컬렉터를 사용한 메트릭 파이프라인
- 플루언트비트를 사용한 로그 파이프라인