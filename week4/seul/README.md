# 프로메테우스 오퍼레이터

- 프로케테우스 오퍼레이터를 사용하여 타깃으로부터 메트릭 수집을 자동화할 수 있음
- 쿠버네티스의 서비스를 모니터링하는 서비스 모니터와 파드를 모니터링하는 파드 모니터를 통해 쿠버네티스에 변경이 발생하면 자동으로 프로메테우스 타깃 정보를 변경함
- 파드는 상태가 자주 변경되므로 일반적인 환경에서는 서비스 모니터를 사용하는 것을 권장

### 서비스 모니터

- 서비스 모니터는 커스텀 리소스로 프로메테우스가 서비스를 어떻게 발견하고 스크레이핑해야 할지는 정의함
- 서비스는 레이블 셀렉터로 발견한 파드의 엔드포인트를 모니터링할 엔드포인트로 추가함

</br>

# 프로메테우스 오토스케일링

### 프로메테우스 어댑터

프로메테우스 어댑터는 쿠버네티스의 HPA에 사용될 Custom Metric 지표를 생성해서 제공하기 위한 도구

### KEDA 오토스케일

프로메테우스 어댑터는 아래와 같은 문제점이 있어서 현업에서는 KEDA를 많이 사용한다고 함

- 프로메테우스 메트릭만 측정할 수 있으며 다른 시스템 메트릭과 직접적인 연계가 어려움
- 설정이 복잡함
- 호환성에 문제가 있음

KEDA는 스케일 오브젝트라는 커스텀 리소스를 사용해서 HPA를 자동 생성하고 제어함

</br>

# 프로메테우스 알람

### 규칙 매니저와 알람 매니저

- 규칙 매니저: 레코딩 규칙과 알람 규칙을 관리
- 알람 매니저: 알람 규칙에서 생성된 알람을 전달받고 통지로 변환

### 알람의 상태

정의된 알람 규칙의 조건에 만족하면 펜딩(pending), 파이어링(firing), 활성 상태로 변화가 일어남

- 활성 상태: 펜딩이나 파이어링 상태가 아닌 정상 상태
- 펜딩: 조건을 만족하는 알람 규칙이 감지되었으나 파이어링되기 전 상태
- 파이어링: 정의된 임곗값 이상으로 장시간 활성 상태

### 그라파나에서 알람 설정

그라파나 매니지드 알람에서는 다양한 데이터 소스에 알람을 생성할 수 있으나, 레코딩 규칙을 지원하지 않으며 특정 데이터소스는 복잡한 규칙 개발이 어려움

# 프로메테우스 운영 아키텍처

### 샤딩 아키텍처

샤딩은 스크래핑 타깃 목록을 2개 이상의 프로메테우스로 분할하는 것을 뜻하며 수직 샤딩과 수평 샤딩이 있음

- 수직 샤딩: 스크래핑 작업을 논리 그룹으로 분할한 후, 그룹을 다른 프로메테우스 인스턴스에 할당. 일반적인 방식
- 수평 샤딩: 하나의 프로메테우스 서버가 여러 인스턴스를 가지며, 각 인스턴스는 수어진 작업에 대한 타깃 하위 세트를 스크래핑 함

### 페더레이션 아키텍처

- 계층적 페더레이션: 트리 구조와 같이 상위 레벨의 역할을 하는 프로메테우스 인스턴스에서 하나 이상의 하위 프로메테우스 서버의 시계열을 스크래핑하고 집계
- 교차 서비스: 한 서비스의 프로메테우스 서버에서 다른 서비스의 프로메테우스 서버가 선택한 데이터를 스크랩하도록 구성하여 단일 서버 내에서 두 데이터셋에 대한 경고와 쿼리를 가능하게 함

</br>

# 타노스 운영

### 타노스 아키텍처

다수의 프로메테우스를 설치, 운영할 경우 저장 공간과 성능의 한계에 부딪히게 되는데 타노스를 사용하여 이를 해결할 수 있음

**타노스의 장점**

- 시계열의 중복을 제거함
- 다운 샘플링된 데이터를 자동으로 생성하여 오랜 기간에 걸친 데이터를 쿼리할 수 있게 됨
- 다르 ㄴ프로메테우스 샤드의 메트릭을 혼합하는 글로벌 알람 규칙과 레코딩 규칙을 생성할 수 있음
- 스토리지의 내구성, 신뢰성, 확장성 문제를 모니터링 스택 외부에 장기 보관할 수 있음

### 타노스 사이드카 방식

프로메테우스와 함께 로컬로 배포되고 원격 읽기 API를 통해 연결됨 (pull 방식)

문제점

- 별도의 배포가 필요하고 파드 라이프 사이클에 영향을 미침
- 추가적인 리소스를 사용하므로 비용이 증가함
- 프로메테우스 파드에 종속적이고 멀티 테넌트와 같은 복잡한 구성에 제약을 받음

### 타노스 리시버 방식

사이드카의 문제점을 해결하기 위해 push 방식을 지원하는 방식으로 나왔으며 원격 쓰기 방식을 사용