## 프로메테우스 오토스케일링
### 프로메테우스 어댑터
```
# minikube 환경 구축(for mac)
$ minikube start --cpus=4 --memory=8192 --driver=docker


# 오퍼레이터 설치
$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
$ helm install prometheus prometheus-community/kube-prometheus-stack  

# 설치된 파드 확인 
$ kubectl get pods 
$ kubectl get servicemonitor

# 포트포워딩 구성
$ kubectl port-forward svc/prometheus-kube-prometheus-prometheus 9090
```
- 프로메테우스 어댑터는 'discovery'규칙을 통해 노출할 메트릭과 이를 노출하는 방법 결정
- 각 규칙은 다음의 네 부분으로 나눔
1. discovery: 사용자 지정 메트릭 API에서 노출하려는 메트릭을 찾는 프로세스 관리
2. naming: 어댑터가 사용자 정의 메트릭 API에서 메트릭을 노출하는 방법을 지정
3. querying: 하나 이상의 쿠버네티스 개체의 특정 메트릭에 대한 요청을 프로메테우스의 쿼리로 변환
4. association: 어댑터가 특정 메트릭이 연결된 쿠버네티스 리소스를 결정하는 방법 지정

## 프로메테우스 알람
1. 규칙 매니저: 레코딩 규칙과 알람 규칙 관리, 평가 주기에 따라 규칙을 정기적으로 평가하고 알람 사이클 관리
2. 알람 매니저: 알람 규칙에서 생성된 알람을 전달받고 통지로 변환 

### 프로메테우스의 알람 전송 흐름
기록, 알람 규칙 작성 &rarr; 규칙 매니저 &rarr; 알람 매니저 &rarr; 알람 전송

## 프로메테우스 운영 아키텍쳐
### 샤딩 아키텍쳐
- 프로메테우스 구성을 위한 기본적인 가이드라인: 높은 카디널리티 메트릭 생성 피하기, **샤딩** 구성하기 
1. 수직 샤딩: 프로메테우스 서버가 기준
2. 수평 샤딩: 샤드를 기준으로 메트릭 수집, 하나의 프로메테우스 서버가 여러 인스턴스를 갖는 것을 의미

&rarr; 프로메테우스 인스턴스만으로 충분치 않을때 스케일링을 하기 위한 좋은 출발점은 스크래핑 작업을 논리 그룹으로 분할한 후, 그룹을 다른 프로메테우스 인스턴스에 할당(수직 샤딩) 
### 페더레이션 아키텍쳐
- 계층적 페더레이션
    - 하위 레벨 인스턴스의 메트릭을 좀 더 포괄적인 시계열로 집계 가능
    - 트리 구조와 같이 상위 레벨의 역할을 하는 프로메테우스 인스턴스에서 하나 이상의 하위 프로메테우스 서버의 시계열을 스크래핑하고 집계하는 것
    - 문점: 메트릭 세트를 미리 집계하거나 직접 선택해야 함 &rarr; 메트릭을 생성/소비하는 인스턴스에 부정적인 성능 영향
- 교차 서비스
    - 한 서비스의 프로메테우스 서버에서 다른 서비스의 프로메테우스 서버가 선택한 데이터를 스크랩하도록 구성해 단일 서버 내에서 두 데이터셋에 대한 경고와 쿼리를 가능하게 함 
    - 동일 레벨의 프로메테우스 서버 사이의 페더레이션을 구성하는 것 
## 타노스 운영
### 타노스 아키텍쳐
- 프로메테우스의 장점이자 단점: 안정성과 성능을 목표로 하기에 클러스터링이 제공되지 X / 여러 팀이 서로 다른 요구 사항을 제시하면 유지 관리가 어려움 &rarr; 타노스의 등장
- 타노스 사이드카: 프로메테우스 인스턴스의 데이터를 다른 타노스의 컴포넌트에서 사용할 수 있게 하고 쿼리어는 수신한 쿼리를 사이드카나 다른 타노스 구성 요소로 분배하는 API

- 프로메테우스의 단점과 이를 보완하는 타노스
    - 단점
        - 내구성 부재
        - 수평적 확장 불가
    - 보완
        - 글로벌 뷰
        - 다운 샘플링 
        - 규칙
        - 장기 보관
### 타노스 사이드카 방식
- 사이드카는 **원격 읽기** 방식 사용(pull 방식) 
- 타노스 쿼리: 타노스 쿼리어와 사이드카는 글로벌 뷰 문제를 해결
- 타노스 사이드카: 인스턴스의 TSDB 블록을 객체 스토리지에 제공하는 데몬
- 타노스 스토어 게이트 웨이: 스토어 API 엔드포인트를 통해 객체 스토리지로 전달되는 블록의 과거 시계열에 대한 액세스 제공 
- 타노스 콤팩터: 타노스 업로드 기능이 안정적으로 작동하기 위한 압축 작업 처리 
- 타노스 버킷: 객체 스토리지의 블록 검증, 복구, 나열, 검사를 담당
### 타노스 리시버 방식
- **원격 쓰기**를 수용하고 데이터 노출 및 블록을 객체 스토리지로 전달하는 데몬 

```
# 타노스 다운로드
wget https://github.com/thanos-io/thanos/releases/download/v0.25.0/thanos-0.25.0.linux-amd64.tar.gz

```